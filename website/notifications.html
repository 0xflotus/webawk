<!doctype html>
<html lang="en-us">
<head>
	<meta charset="utf-8">
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>WebAWK with Callbacks</title>

	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
	<script src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/js/bootstrap.min.js"></script>
	<link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.2.1/css/bootstrap-combined.min.css"
		rel="stylesheet">
	<script src="http://d1n0x3qji82z53.cloudfront.net/src-min-noconflict/ace.js"
		type="text/javascript" charset="utf-8"></script>

<style type="text/css" media="screen">
#awk_program {
	width: 400px;
	height: 200px;
}

#input_data {
	width: 400px;
	height: 200px;
}

#source_code_row {
	min-height: 250px;
}
</style>

</head>

<body>

<div class="container">

<div class="row" id="source_code_row">
	<div class="span6">
		<h2>AWK Program</h2>
		<div id="awk_program">BEGIN {
	print "Hello from Web/AWK World"
}
$2 ~ /C/ { print $1 * 2 }</div>
	</div>

	<div class="span6">
		<h2>Input File</h2>
		<div id="input_data">1   A
2   B
3   C
4   D</div>
	</div>
</div>

<br/>
<div class="row">
	<div class="span12">
	<input class="button btn-primary" type="button" value="Run" onclick="go_awk_go()"/>
	</div>
</div>

<div class="row">
	<div class="span12">

	<div style="display: none;" id="awk_error_msg">
		<br/>
		<div class="alert alert-error">
		Oops! seems like your AWK program failed!<p>
		Please check the syntax and try again...
		</div>
	</div>

	<h4>Output</h4>
	<pre id="output_file">
	</pre>

	</div>
</div>

</div> <!-- container -->

<script type="text/javascript">

function pausecomp(millis) {
	var date = new Date();
	var curDate = null;

	do { curDate = new Date(); }
	while(curDate-date < millis);
}

function webawk_notification_callback(type,start_line,start_pos,end_line,end_pos)
{

	switch(type)
	{
	case NTBT_ENTER_BEGIN_BLOCK:
	case NTBT_EXIT_BEGIN_BLOCK:
	case NTBT_ENTER_END_BLOCK:
	case NTBT_EXIT_END_BLOCK:
	case NTBT_ENTER_ACTION:
	case NTBT_EXIT_ACTION:
	case NTBT_ENTER_PATTERN:
	case NTBT_TAKE_PATTERN:
	case NTBT_EXIT_PATTERN:
	case NTBT_IMPLICIT_PATTERN:
	case NTBT_IMPLICIT_ACTION:
		var sel = src_editor.getSelection();
		sel.setSelectionRange(new Range(start_line,start_pos,end_line,end_pos));
		break;

	case NTBT_GETLINE:
		var sel = input_editor.getSelection();
		sel.setSelectionRange(new Range(start_line,0,end_line+1,0));
		break;
	}

	console.log("weback no: " + webawk_notification_names[type]);
}

function go_awk_go()
{

	//Disable highlighting, while we have notification callbacks
	src_editor.setHighlightActiveLine(false);
	input_editor.setHighlightActiveLine(false);

	var awk_source = src_editor.getValue();
	var sample_input = input_editor.getValue();

	var awk = run_web_awk( awk_source, sample_input ) ;

	$("#output_file").text (  awk.stderr + "\n" + awk.stdout );

	//show the error <div>
	if (awk.exit_code != 0) {
		$("#awk_error_msg").show();
	} else {
		$("#awk_error_msg").hide();
	}

	//Enable highlighting
	src_editor.setHighlightActiveLine(true);
	input_editor.setHighlightActiveLine(true);
}

// see  http://stackoverflow.com/questions/10452869/when-i-try-to-create-a-range-object-in-ace-js-an-illegal-constructor-error-is
var Range = ace.require('ace/range').Range ;

var src_editor = ace.edit("awk_program");
src_editor.setTheme("ace/theme/github");
src_editor.getSession().setMode("ace/mode/javascript");

var input_editor = ace.edit("input_data");
input_editor.setTheme("ace/theme/github");
input_editor.getSession().setMode("ace/mode/javascript");

</script>

<script src="awk_web.js" type='text/javascript'></script>

</body>
</html>
